define(["./constants","./audio","./components","./multi"],function(b,e,B,C){var d;var o;var h;var j=false;var A=b.getViewportSize("px");function u(G){d=G}function f(){return d}function k(G){o=G}function n(){return o}function i(G){h=G}function E(){return h}function p(G){$.ajax({url:"/levelLoad",type:"POST",dataType:"json",data:{number:n()},success:function(H){G(H)}})}function q(G){$.ajax({url:"/saveGame",type:"POST",dataType:"json",data:{student:E(),level:n()},success:function(H){G(H)}})}function a(G,I,H){switch(H){default:break;case 1:u(Crafty.e("Character").at(G,I));break;case 2:Crafty.e("Floor1").at(G,I);break;case 3:Crafty.e("Floor2").at(G,I);break;case 4:Crafty.e("Floor3").at(G,I);break;case 5:Crafty.e("Floor4").at(G,I);break;case 6:Crafty.e("Floor5").at(G,I);break;case 7:Crafty.e("Abyss").at(G,I);break;case 8:Crafty.e("Hide").at(G,I);break;case 9:Crafty.e("Chest").at(G,I);break;case 10:Crafty.e("Enemy1").at(G,I);break;case 11:Crafty.e("Enemy2").at(G,I);break;case 12:Crafty.e("Enemy3").at(G,I);break;case 13:Crafty.e("Enemy4").at(G,I);break;case 14:Crafty.e("Enemy5").at(G,I);break;case 15:Crafty.e("Exit").at(G,I);break}}function t(G){Crafty("obj").each(function(){this.destroy()});Crafty.background(G||"url('/assets/img/backgrounds/wall"+(Math.floor(Math.random()*5)+1)+".jpg') no-repeat")}function c(H){C.setEnemyTotal(0);var I=C.getMultiplayer();for(var G in H.map){x=Math.floor(parseInt(G,10)%b.getLevelSize("tiles").width);y=Math.floor(parseInt(G,10)/b.getLevelSize("tiles").width);type=H.map[G];a(x,y,H.map[G])}var J;if(I==="connector"){if(!j){j=true;Crafty("Character").addComponent("Mimic").connectorMode()}else{Crafty("Character").addComponent("Mimic").restartMimic()}J=Crafty("Character").getMultiPosition();Crafty.e("Multiplayer").at(J[0],J[1])}else{if(I==="creator"){if(!j){j=true;Crafty("Character").addComponent("Mimic").creatorMode()}else{Crafty("Character").addComponent("Mimic").restartMimic()}J=Crafty("Character").getMultiPosition();Crafty.e("Multiplayer").at(J[0],J[1])}}if(Crafty("Multiplayer").length>0){Crafty("Character").multiplayerUpdateHealth(C.getEnemyTotal())}Crafty.viewport.centerOn(f(),0);Crafty.viewport.follow(f(),0,0);F()}function z(){A=b.getViewportSize("px");Crafty.viewport.init(A.width,A.height);$(".bottom").css({width:b.getViewportSize("px").width});$("canvas").remove();Crafty.canvas.init();Crafty.trigger("InvalidateViewport")}function F(){var G=null;window.onresize=function(){if(G!==null){clearTimeout(G)}G=setTimeout(function(){z()},10)}}function m(){Crafty.init(b.getLevelSize("px").width,b.getLevelSize("px").height);Crafty.viewport.init(A.width,A.height);Crafty.canvas.init()}function l(){var G=['<div id="back">Salir</div>','<div id="music" name="si">Sonido: SÍ</div>','<div class="bottom">','<div class="lifebox">','<span id="vidatext">Vida</span><div class="bar"><div id="lifebar"></div></div>','<span hidden>Enemigo</span><div hidden class="bar"><div id="enemybar"></div></div>',"</div>",'<div class="alert">','<span id="alerttext">RADAR</span><div id="timeout">OK</div>',"</div>",'<div class="inventory">',"<span>Bonus<br/></span>","</div>","</div>"].join("\n");$("body").append(G);$("#back").on("click",function(){if(confirm("¿Quieres salir del juego?")){t();window.location="/game"}});$("#music").on("click",function(){if($("#music").attr("name")==="si"){$("#music").text("Sonido: NO");$("#music").attr("name","no");Crafty.audio.mute()}else{$("#music").text("Sonido: SÍ");$("#music").attr("name","si");Crafty.audio.unmute()}});$(".bottom").css({width:b.getViewportSize("px").width})}function w(){Crafty.scene("Game",function(G){c(G);l();e.playLevel()})}function D(){Crafty.scene("Next",function(H){var G=['<div class="popup">','<div class="separator">¡NIVEL SUPERADO!</div>',"<p>Pulsa Siguiente para ir al siguiente nivel</p>",'<input class="button" type="button" value="Siguiente"/>',"</div>"].join("\n");e.stopLevel();$(".bottom").remove();$("#back").remove();$("#music").remove();$("#cr-stage").fadeOut(1000,function(){$("body").append(G);$(".button").on("click",function(){$(".popup").remove();t();$("#cr-stage").show();Crafty.scene("Game",H)})})})}function s(){Crafty.scene("End",function(){var G=['<div id="exp">',"<h1>¡Enhorabuena, destruiste a tus enemigos y saliste con vida!<br/>","<p>Ahora eres un experto resolviendo polinomios :)</p>",'<input class="button" type="button" value="Volver al menu"/></div>'].join("\n");e.stopLevel();$(".bottom").remove();$("#back").remove();$("#music").remove();$("#cr-stage").fadeOut(1000,function(){$("body").append(G);$("h1").css({"text-align":"center",color:"white","border-bottom":"solid 1px #999999","line-height":"150%",padding:"10px"});$(".button").css({clear:"both","float":"left","margin-top":"50px","margin-left":"45%"});$(".button").on("click",function(){$("#exp").remove();Crafty.stop();$("#cr-stage").remove();window.location="/"})})})}function g(){Crafty.scene("Death",function(H){var G=['<div class="popup">','<div class="separator">¡HAS MUERTO!</div>',"<p>¡Vuelve a intentarlo!</p>",'<input class="button" type="button" value="¡Venganza!"/>',"</div>"].join("\n");$(".bottom").remove();$("#back").remove();$("#music").remove();$("#cr-stage").fadeOut(1000,function(){$("body").append(G);$(".button").on("click",function(){$(".popup").remove();t();$("#cr-stage").show();Crafty.scene("Game",H)})})})}function r(){Crafty.scene("Loading",function(M){var K=['<div id="exp">',"<h1>Cargando...</h1>",'<div id="loading"><div id="progress"></div></div>',"<table><tr>",'<td class="ltuto"><img src="/assets/img/tutorial/tutorial1.jpg"/></td>',"</tr><tr>",'<td class="rtuto"><img src="/assets/img/tutorial/tutorial2.jpg"/></td>',"</tr><tr>",'<td class="ltuto"><img src="/assets/img/tutorial/tutorial3.jpg"/></td>',"</tr></table>"].join("\n");$("#cr-stage").hide();$("body").append(K);$("h1").css({"text-align":"center",color:"white"});$("table").css({width:"80%",margin:"0px auto"});$(".ltuto").css({"margin-top":"30px","float":"left","box-shadow":"10px 10px 10px #111111"});$(".rtuto").css({"margin-top":"30px","float":"right","box-shadow":"10px 10px 10px #111111"});$("#loading").css({margin:"0 auto",border:"1px solid #FFF","background-color":"#000",width:"500px",height:"10px","box-shadow":"10px 10px 10px #111111"});$("#progress").css({border:"0px","background-color":"#999",width:"100px",height:"10px"});var L=["/assets/img/backgrounds/wall1.jpg","/assets/img/backgrounds/wall2.jpg","/assets/img/backgrounds/wall3.jpg","/assets/img/backgrounds/wall4.jpg","/assets/img/backgrounds/wall5.jpg"];var I=false;var J=444;var H=setInterval(function(){if(!I){if(J===999){J=444}J=J+111;$("#progress").css({"background-color":"#"+J})}else{clearInterval(H)}},100);var G=B.getGameGraphics();e.addAudio();L.join(e.loadAudio());L.join(G);Crafty.load(L,function(){I=true;B.setGameGraphics(G);$("#loading").remove();$("h1").text("¡Todo listo!");$("table").before('<div id="cont"><input class="button" type="button" value="¡Empezar!"/></div>');$("#cont").css({margin:"0 auto","text-align":"center"});$(".button").on("click",function(){$("#exp").remove();t();$("#cr-stage").show();Crafty.scene("Game",M)})},function(N){$("#progress").width(N.percent*5)})})}function v(){w();r();g();s();D()}return{newGame:function(G,I,H){i(G);k(I);C.setMultiplayer(H);p(function(J){v();if(J.map){m();if(H==="connector"){Crafty.scene("Loading",J)}else{q(function(K){Crafty.scene("Loading",J)})}}else{Crafty.scene("End")}})},nextLevel:function(G){k(n()+1);p(function(H){if(H.map){if(C.getMultiplayer()==="connector"){Crafty.scene("Next",H)}else{q(function(I){Crafty.scene("Next",H)})}}else{Crafty.scene("End")}})},restartLevel:function(){p(function(G){if(G.map){Crafty.scene("Death",G)}})}}});