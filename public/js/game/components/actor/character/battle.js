define(["../../../audio"],function(f){var m=9;var B=6;var b=4;var e=0.5;var q=0.75;var G=false;var l=2999;var r=2999;var k=15999;var D=2999;var d=14999;var g=3000;var F=100;var w="rgba(0,255,50,0.8)";var C="rgba(255,0,50,0.8)";var z="rgba(200,200,200,0.8)";function c(H){$.ajax({url:"/getTimeoutsFile",type:"POST",dataType:"html",success:function(L){var M=L.split(/\n/);for(var I=0;I<M.length;I++){var J=M[I].split(":");if(J[1]!==undefined&&J[1]!==""){var K=parseInt(J[1],10);if(!isNaN(K)){switch(J[0]){case"SUMA":l=K;break;case"RESTA":r=K;break;case"MULTIPLICACION":k=K;break;case"NOTABLE":D=K;break;case"DIVISION":d=K;break}}}}H()}})}function p(){var J=[];var I=true;var H=true;while(I||H){J=[];H=true;I=true;for(i=0;i<B;i++){if(J.length<b){if(Math.random()<=q){J[i]=Math.floor(Math.random()*(m)+1);if(Math.random()<=e){J[i]=-J[i]}I=false;if(i>0){H=false}}else{J[i]=0}}else{J[i]=0}}}return J}function A(J){var I=[];for(var H=0;H<J.length;H++){I[H]="";if(J[H]!==0){if(J[H]>0){I[H]+="+"}if(J[H]===-1&&H!==0){I[H]+="-"}else{if(!(J[H]===1&&H!==0)){I[H]+=J[H]}}if(H>0){I[H]+="x";if(H>1){I[H]+="<sup>"+H+"</sup>"}}}}return I.reverse().join(" ").trim()}function s(){var I=Math.floor(B/2);var K=Math.floor(Math.random()*(3)+1);var H=[];var N=[];for(var J=0;J<B;J++){N[J]=0;H[J]=0}var L=[0,0];while(L[0]===L[1]){L=[Math.floor(Math.random()*(I)+1),Math.floor(Math.random()*(I)+1)]}var M=[0,0];M=[Math.floor(Math.random()*(m)+1),Math.floor(Math.random()*(m)+1)];N[L[0]]=M[0];N[L[1]]=M[1];switch(K){case 1:H[L[0]*2]=M[0]*M[0];H[L[1]*2]=M[1]*M[1];H[L[0]+L[1]]=2*M[0]*M[1];break;case 2:H[L[0]*2]=M[0]*M[0];H[L[1]*2]=M[1]*M[1];H[L[0]+L[1]]=-2*M[0]*M[1];N[L[1]]=-M[1];break;case 3:H[L[0]*2]=M[0]*M[0];H[L[1]*2]=-M[1]*M[1];break}return[N,H,K]}function a(){var H=s();Crafty("Character")._battleSolution[0]=H[1];Crafty("Character")._battleSolution[1]=H[2];return u(H[0],H[2])}function y(){var H=s();Crafty("Character")._battleSolution[0]=H[0];Crafty("Character")._battleSolution[1]=H[2];return A(H[1])}function u(K,I){switch(I){case 3:html="("+A(K)+")".replace(/\n/g,"");var J=false;for(var H=K.length-1;H>=0;H--){if(!J&&K[H]>0){J=true}else{if(J&&K[H]>0){K[H]=-K[H]}}}html+="("+A(K)+")".replace(/\n/g,"");break;default:html="("+A(K)+")<sup>2</sup>".replace(/\n/g,"");break}return html}function E(){var J;var L=Math.floor(Math.random()*(B/2)+1);var M=Math.floor(Math.random()*(m/2)+1);this._battleSolution=[];for(J=0;J<B;J++){this._battleSolution[J]=0;if(J===L){this._battleSolution[L]=M}}var K=b;b=Math.floor(b/2);var I=p();b=K;var H=[];for(J=0;J<B;J++){for(j=0;j<B;j++){if(H[J+j]===undefined){H[J+j]=0}H[J+j]=H[J+j]+I[J]*this._battleSolution[j]}}return[A(H),A(I)]}function n(){var I=b;b=2;var H=[p(),p(),p(),p()];b=I;solution=[[],[]];for(i=0;i<B;i++){for(j=0;j<B;j++){solution[0][i+j*B]=0;solution[1][i+j*B]=0}}for(i=0;i<B;i++){for(j=0;j<B;j++){solution[0][i+j]=solution[0][i+j]+H[0][i]*H[2][j];solution[1][i+j]=solution[1][i+j]+H[1][i]*H[3][j]}}Crafty("Character")._battleSolution=solution;return[A(H[0]),A(H[1]),A(H[2]),A(H[3])]}function v(){var I=b;b=2;var H=[p(),p(),p(),p()];b=I;solution=[[],[]];for(i=0;i<B;i++){for(j=0;j<B;j++){solution[0][i+j*B]=0;solution[1][i+j*B]=0}}for(i=0;i<B;i++){for(j=0;j<B;j++){solution[0][i+j]=solution[0][i+j]+H[0][i]*H[3][j];solution[1][i+j]=solution[1][i+j]+H[1][i]*H[2][j]}}Crafty("Character")._battleSolution=solution;return[A(H[0]),A(H[1]),A(H[2]),A(H[3])]}function t(H){var I=H;if(H>=96&&H<=105){I=H-48}else{if(H===109){I=173}else{if(H===107){I=171}else{if(H===187){I=171}else{if(H===189){I=173}}}}}return I}function x(I){var H=I.split("x");var K=0;var J=0;if(H.length===1){K=parseInt(H[0],10);if(isNaN(K)){K=0}J=0}else{if(H.length===2){if(H[0]==="+"){K=1}else{if(H[0]==="-"){K=-1}else{if(H[0]===""){K=1}else{K=parseInt(H[0],10);if(isNaN(K)){K=0}}}}if(H[1]===""){J=1}else{J=parseInt(H[1].replace("^",""),10);if(isNaN(J)){J=-1}}}}return[J,K]}function h(L){var I=L.replace(/[\+]/g,"%+").replace(/[\-]/g,"%-").split("%");var H=[];var K=[];for(var J=0;J<I.length;J++){if(I[J]!=="+"||I[J]!=="-"){K=x(I[J]);H[K[0]]=K[1]}}return H}function o(L){var K=0;var J=L.replace(/[\ -\'|\*|\,|\.-\/|\:-\]|\_-w|y-\~]/g,"");J=J.replace(/\(/g,"").split(")");solution=[];if(J.length===1){solution=h(J[0])}else{if(J.length===2&&J[1]==="^2"){solution=h(J[0])}else{if(J.length===3&&J[2]===""){var I=h(J[0]);var H=h(J[1]);if(I===H){solution=[]}else{solution[0]=I;solution[1]=H;for(K=0;K<B;K++){if(solution[0][K]===undefined){solution[0][K]=0}if(solution[1][K]===undefined){solution[1][K]=0}}return solution}}}}for(K=0;K<B;K++){if(solution[K]===undefined){solution[K]=0}}return solution}return{createComponent:function(){Crafty.c("Battle",{_battleFighting:false,_battleOperation:undefined,_battleTimed:false,_battleTimeout:undefined,_battleTimer:undefined,_battleSolution:[],_battleResult:undefined,addOperation:function(){var I=[p(),p()];var H=[];for(var J=0;J<B;J++){H[J]=I[0][J]+I[1][J]}this._battleSolution=H;return[A(I[0]),A(I[1])]},subOperation:function(){var I=[p(),p()];var H=[];for(var J=0;J<B;J++){H[J]=I[0][J]-I[1][J]}this._battleSolution=H;return[A(I[0]),A(I[1])]},divOperation:function(H){switch(H){case"simplify":return E();case"product":return n();case"cocient":return v()}},notableOperation:function(H){switch(H){case"expand":return a();case"compress":return y()}},mulOperation:function(){var H=[];H[0]=p();var I=b;b=2;H[1]=p();b=I;for(i=0;i<B;i++){for(j=0;j<B;j++){this._battleSolution[i+j*B]=0}}for(i=0;i<B;i++){for(j=0;j<B;j++){this._battleSolution[i+j]=this._battleSolution[i+j]+H[0][i]*H[1][j]}}return[A(H[0]),A(H[1])]},whichOperation:function(){var H=this._detectionEnemy;if(H.has("Enemy1")){this._battleTimeout=l;this._battleOperation="+"}else{if(H.has("Enemy2")){this._battleTimeout=r;this._battleOperation="-"}else{if(H.has("Enemy3")){this._battleTimeout=k;this._battleOperation="*"}else{if(H.has("Enemy4")){this._battleTimeout=D;this._battleOperation="**"}else{if(H.has("Enemy5")){this._battleTimeout=d;this._battleOperation="/"}}}}}if(this._clocks>0){this._battleTimeout+=g}},createHtmlTable:function(J,I){var H=['<div class="battle"><h1>Batalla</h1>','<div class="header">','<h2 class="left">Operación: <span style="color: #F00; line-height: 30px">'+J+"</span></h2>",'<h2 class="right">Tiempo restante: <span id="time" class="big">'+this._battleTimeout+"</span></h2>","</div>",'<table class="poly">'].join("\n");if(this._battleOperation==="/2"||this._battleOperation==="/3"){H+=["<tr><td>"+I[0]+"</td><td>"+I[2]+"</td></tr>","<tr><td><hr/></td><td><hr/></td></tr>","<tr><td>"+I[1]+"</td><td>"+I[3]+"</td></tr></table>",'<input id="solution1" class="solution" type="text" placeholder="Introduce el numerador del resultado"/>','<br/><input id="solution2" class="solution" type="text" placeholder="Introduce el denominador del resultado"/>',"</div>"].join("\n")}else{if(this._battleOperation==="**1"||this._battleOperation==="**2"){H+=["<tr><td>"+I+"</td></tr></table>",'<input id="solution" class="solution" type="text" placeholder="Introduce la solución"/>',"</div>"].join("\n")}else{H+="<tr><td>"+I[0]+"</td></tr>";if(this._battleOperation==="/1"){H+="<tr><td><hr/></td></tr>"}H+=["<tr><td>"+I[1]+"</td></tr></table>",'<input id="solution" class="solution" type="text" placeholder="Introduce la solución"/>',"</div>"].join("\n")}}$("#cr-stage").append(H);$("#enemybar").css({width:(this._detectionEnemy._enemyHealth*3)+"px"});$($(".lifebox").children()[2]).show();$($(".lifebox").children()[3]).show()},setTimeHandler:function(){if(this._battleResult!==undefined){H=F;if(this._battleResult){$(".battle").css({background:w})}else{$(".battle").css({background:C})}}if(this._battleTimed){var J=this._battleTimeout;var H=0;$("#time").css({text:"#FF0000"})}else{$("#time").css({text:"#00FF00"}).text("∞")}var I=new Date();this._battleTimer=setInterval(function(){var K=(new Date().getTime()-I.getTime());if(Crafty("Character")._battleTimed){if(K>100){J-=parseInt(K/10,10);if(H>0){H-=parseInt(K/10,10)}}else{J-=1;if(H>0){H-=1}}if(J<=0){Crafty("Character").clearBattle();Crafty("Character")._battleResult=false;if(Crafty("Character")._health>0){Crafty("Character").battle(Crafty("Character")._battleTimed)}Crafty("Character").damage("enemy")}else{if(H<=0){$(".battle").css({background:z});H=0}}$("#time").text((J/100).toFixed(2))}else{if(K>100){if(H>0){H-=parseInt(K,10)}}else{if(H>0){H-=10}}if(H<=0){$(".battle").css({background:z});H=0}}I=new Date()},10)},polynomialBattle:function(){this.whichOperation();var I;var H;switch(this._battleOperation){case"*":I="MULTIPLICACIÓN";H=this.mulOperation();break;case"**":if(Math.random()<0.5){I="EXPANDE EL PRODUCTO NOTABLE";this._battleOperation="**1";H=this.notableOperation("expand")}else{I="CONVIERTE EN PRODUCTO NOTABLE";this._battleOperation="**2";H=this.notableOperation("compress")}break;case"/":var J=Math.random();if(J<0.33){I="SIMPLIFICA";this._battleOperation="/1";H=this.divOperation("simplify")}else{if(J>=0.33&&J<0.66){I="MULTIPLICA";this._battleOperation="/2";H=this.divOperation("product")}else{I="DIVIDE";this._battleOperation="/3";H=this.divOperation("cocient")}}break;case"+":I="SUMA";H=this.addOperation();break;case"-":I="RESTA";H=this.subOperation()}this.createHtmlTable(I,H);this.setTimeHandler()},polynomialKeyboard:function(){if(this._battleOperation==="/1"||this._battleOperation.charAt(0)!=="/"){$("#solution").focus();$("#solution").on("keydown",function(I){var H=I.keyCode||I.which;if(H===13){if(this.value!==""){Crafty("Character").checkSolution(o(this.value))}}});$("#solution").on("keyup",function(I){var H=this.value.replace(/[\!-\'|\*|\,|\.-\/|\:-\]|\_-w|y-\~]/g,"");if(this.value!=H){this.value=H}})}else{$("#solution1").focus();$("#solution1").on("keydown",function(I){var H=I.keyCode||I.which;if(H===13){if(this.value!==""){Crafty("Character").checkSolution(o(this.value),o($("#solution2").val()))}}});$("#solution2").on("keydown",function(I){var H=I.keyCode||I.which;if(H===13){if(this.value!==""){Crafty("Character").checkSolution(o($("#solution1").val()),o(this.value))}}});$("#solution1").on("keyup",function(I){var H=this.value.replace(/[\!-\'|\*|\,|\.-\/|\:-\]|\_-w|y-\~]/g,"");if(this.value!=H){this.value=H}});$("#solution2").on("keyup",function(I){var H=this.value.replace(/[\!-\'|\*|\,|\.-\/|\:-\]|\_-w|y-\~]/g,"");if(this.value!=H){this.value=H}})}},polynomialCocientArray:function(L){this._battlePolynomials[1]=this._battlePolynomials[0];var I=this.polynomialArray(m,L);var H=[];delete this._battlePolynomials[0][0];for(var K=1;K<m;K++){if(this._battlePolynomials[0][K]!==undefined){for(var J=1;J<m;J++){if(I[J]!==undefined){if(H[K+J]===undefined){H[K+J]=0}H[K+J]=H[K+J]+this._battlePolynomials[0][K]*I[J]}}}}this._battleQuotient=I;this._battlePolynomials[0]=H},checkSolution:function(Q,O){var P=true;var K=true,I=true;var L=false,J=false;var N=0,M=0;switch(this._battleOperation){case"/2":for(N=0;N<this._battleSolution[0].length;N++){if((Q[N]!==undefined)&&(this._battleSolution[0][N]!==Q[N])){K=false;break}}for(N=0;N<this._battleSolution[1].length;N++){if((O[N]!==undefined)&&(this._battleSolution[1][N]!==O[N])){I=false;break}}P=K&&I;break;case"/3":for(N=0;N<this._battleSolution[0].length;N++){if((Q[N]!==undefined)&&(this._battleSolution[0][N]!==Q[N])){K=false;break}}for(N=0;N<this._battleSolution[1].length;N++){if((O[N]!==undefined)&&(this._battleSolution[1][N]!==O[N])){I=false;break}}P=K&&I;break;case"*":for(N=0;N<this._battleSolution.length;N++){if((Q[N]!==undefined)&&(this._battleSolution[N]!==Q[N])){P=false;break}}break;case"**1":if(this._battleSolution[1]===3){var H=false;for(N=0;N<B;N++){if(H&&Q[N]<0){P=false;break}if(!H&&Q[N]<0){H=true}}if(P&&H){for(N=0;N<this._battleSolution[0].length;N++){if(Math.abs(this._battleSolution[0][N])!==Math.abs(Q[N])){P=false;break}}}else{P=false}}else{for(N=0;N<this._battleSolution[0].length;N++){if(this._battleSolution[0][N]!==Q[N]){P=false;break}}}break;case"**2":if(this._battleSolution[1]===2){var R=false;for(N=0;N<B;N++){if(R&&Q[N]<0){P=false;break}if(!R&&Q[N]<0){R=true}}if(P&&R){for(N=0;N<this._battleSolution[0].length;N++){if(Math.abs(this._battleSolution[0][N])!==Math.abs(Q[N])){P=false;break}}}else{P=false}}else{if(this._battleSolution[1]===3){var R=false;for(N=0;N<B;N++){if(R&&Q[0][N]<0){P=false;break}if(!R&&Q[0][N]<0){R=true}if(R&&Q[1][N]<0){P=false;break}if(!R&&Q[1][N]<0){R=true}}if(P&&R){for(N=0;N<this._battleSolution[0].length;N++){if(Math.abs(this._battleSolution[0][N])!==Math.abs(Q[0][N])){P=false;break}}}else{P=false}}else{for(N=0;N<this._battleSolution[0].length;N++){if(this._battleSolution[0][N]!==Q[N]){P=false;break}}}}break;default:for(N=0;N<this._battleSolution.length;N++){if(this._battleSolution[N]!==Q[N]){P=false;break}}break}this.clearBattle();if(P){this._battleResult=true;var S=this._detectionEnemy.damage();if(S){f.stopAlert();f.stopHidden();f.playLevel();if(this._battleTimed){if(this._clocks>0){this._clocks--;if(this._clocks===0){this.removeBonus("clock")}}}this.startAll();this._battleFighting=false}else{if(this._health>0){this.battle(this._battleTimed)}}}else{if(!this._battleTimed){f.stopHidden();f.playAlert()}this.damage("enemy");$("#timeout").css({color:"red","border-color":"red"});$("#timeout").html("ALERTA MÁXIMA, ¡TE HAN PILLADO!");this._battleResult=false;this._battleTimed=true;if(this._health>0){this.battle(this._battleTimed)}}},battle:function(H){this._battleFighting=true;if(H){f.playMonsterScream()}this._battleTimed=H;this.stopAll();this.polynomialBattle();this.polynomialKeyboard()},clearBattle:function(){clearInterval(this._battleTimer);$(".battle").remove();$("body").unbind("keydown")},init:function(){this.requires("Character");if(!G){c(function(){G=true})}}})}}});